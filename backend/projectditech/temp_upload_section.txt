def upload_document(request):
    """Endpoint pour uploader un document (scan de fiche de paie, etc.)"""
    try:
        # VÃ©rifier que le fichier est prÃ©sent
        if 'document' not in request.FILES:
            return Response({
                'error': 'Aucun fichier fourni',
                'detail': 'Le champ "document" est requis'
            }, status=status.HTTP_400_BAD_REQUEST)
        
        document_file = request.FILES['document']
        document_type = request.data.get('document_type', 'OTHER')
        
        # Valider le type de document
        valid_types = [choice[0] for choice in Document.DOCUMENT_TYPE_CHOICES]
        if document_type not in valid_types:
            return Response({
                'error': 'Type de document invalide',
                'detail': f'Le type doit Ãªtre l\'un des suivants: {", ".join(valid_types)}'
            }, status=status.HTTP_400_BAD_REQUEST)
        
        # Valider que c'est une image ou un PDF
        content_type = document_file.content_type or ''
        file_name = document_file.name.lower() if document_file.name else ''
        
        is_image = content_type.startswith('image/')
        is_pdf = (
            content_type == 'application/pdf' or
            file_name.endswith('.pdf')
        )
        
        if not (is_image or is_pdf):
            return Response({
                'error': 'Type de fichier non supportÃ©',
                'detail': 'Seuls les fichiers image (JPG, PNG) et PDF sont acceptÃ©s'
            }, status=status.HTTP_400_BAD_REQUEST)
        
        # CrÃ©er le document
        document = Document.objects.create(
            document=document_file,
            document_type=document_type,
            uploaded_by=request.user,
            description=request.data.get('description', '')
        )
        
        # Si c'est un scan de fiche de paie, essayer de lier Ã  un employÃ© si fourni
        if document_type == 'PAYSLIP_SCAN' and request.data.get('employee_id'):
            try:
                employee = Employee.objects.get(id=request.data.get('employee_id'))
                document.employee = employee
                document.save()
            except Employee.DoesNotExist:
                pass  # On continue mÃªme si l'employÃ© n'existe pas
        
        return Response({
            'success': True,
            'message': 'Document uploadÃ© avec succÃ¨s',
            'document': {
                'id': document.id,
                'document_type': document.get_document_type_display(),
                'document_url': document.document.url if document.document else None,
                'created_at': document.created_at,
            }
        }, status=status.HTTP_201_CREATED)
        
    except Exception as e:
        return Response({
            'error': 'Erreur lors de l\'upload du document',
            'detail': str(e)
        }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)


class PayslipBonusViewSet(viewsets.ModelViewSet):
    """ViewSet pour gÃ©rer les primes des fiches de paie"""
    queryset = PayslipBonus.objects.all()
    serializer_class = PayslipBonusSerializer
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        queryset = super().get_queryset().select_related('payslip', 'payslip__employee')
        payslip_id = self.request.query_params.get('payslip', None)
        
        if payslip_id:
            queryset = queryset.filter(payslip_id=payslip_id)
        
        return queryset
    
    def perform_create(self, serializer):
        bonus = serializer.save()
        # Recalculer le total des primes de la fiche de paie
        payslip = bonus.payslip
        total_bonuses = PayslipBonus.objects.filter(payslip=payslip).aggregate(
            total=models.Sum('amount')
        )['total'] or 0
        payslip.bonuses = total_bonuses
        payslip.save()
    
    def perform_destroy(self, instance):
        payslip = instance.payslip
        super().perform_destroy(instance)
